<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<title>Mätaravläsning</title> 
<meta name="description" content="Mätaravläsning enkelt och effektivt"> 
<meta name="theme-color" content="#1a1a2e">

<style>
:root {
 --primary: #0f3460;
 --secondary: #16213e;
 --accent: #2e7d32;
 --ms-color: #9c27b0;
 --danger: #f44336;
 --text: #f0f0f0;
 --text-secondary: #b0b0b0;
 --card-bg: rgba(255, 255, 255, 0.08);
 --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
 --border-radius: 16px;
}

* { box-sizing: border-box; }

body {
 margin:0;
 padding:0;
 font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
 background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
 color: var(--text);
 touch-action: manipulation;
 min-height: 100vh;
 line-height: 1.6;
 font-size: 20px;
}

.topbar {
 position: sticky;
 top:0;
 width:100%;
 text-align:center;
 padding: 20px 12px;
 font-size: 26px;
 font-weight:700;
 background: rgba(15, 52, 96, 0.9);
 backdrop-filter: blur(10px);
 z-index:1000;
 box-shadow: var(--shadow);
 color: var(--text);
 display: flex;
 align-items: center;
 justify-content: center;
 gap: 12px;
 letter-spacing: 0.5px;
}

.app {
 max-width:100%;
 margin:16px auto 10px;
 display:none;
 padding: 0 16px;
}

.card {
 background: var(--card-bg);
 padding: 20px;
 border-radius: var(--border-radius);
 box-shadow: var(--shadow);
 margin-bottom: 20px;
 opacity:0;
 animation:fadeIn 0.7s ease forwards;
 border: 1px solid rgba(255, 255, 255, 0.1);
 backdrop-filter: blur(10px);
}

.form-group { margin-bottom: 16px; }

label {
 display:block;
 font-weight:600;
 margin-bottom:10px;
 color: var(--text);
 font-size: 22px;
 display: flex;
 align-items: center;
 gap: 10px;
}

select, input {
 width:100%;
 padding:18px;
 border-radius:12px;
 border: 2px solid rgba(255, 255, 255, 0.15);
 background: rgba(0, 0, 0, 0.25);
 color: var(--text);
 font-size:22px;
 margin-bottom:8px;
 min-height:64px;
 font-weight:500;
 transition: all 0.3s ease;
 appearance: none;
 background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23f0f0f0' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
 background-repeat: no-repeat;
 background-position: right 18px center;
 background-size: 22px;
}

select:focus, input:focus {
 outline:none;
 border-color: var(--accent);
 box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.3); }

.last-checked-display {
 padding:18px;
 border-radius:12px;
 background: rgba(0, 0, 0, 0.25);
 font-size:22px;
 color: var(--text);
 margin-bottom:8px;
 display:flex;
 align-items:center;
 font-weight:500;
 border: 2px solid rgba(255, 255, 255, 0.1);
 min-height: 64px;
}

.buttons-container {
 display: flex;
 gap: 12px;
 margin-top: 8px;
 width: 100%;
}

.save-btn {
 flex: 1;
 background: var(--accent);
 font-size:22px;
 padding:20px;
 border-radius:var(--border-radius);
 box-shadow: 0 6px 20px rgba(46, 125, 50, 0.4);
 border: none;
 cursor:pointer;
 font-weight:700;
 color: white;
 opacity:0;
 animation:fadeIn 1s ease forwards;
 animation-delay:0.2s;
 transition: all 0.3s ease;
 min-height:64px;
 letter-spacing: 0.5px;
}

.note-value-btn {
 width: 40%;
 background: var(--ms-color);
 font-size:20px;
 padding:20px 10px;
 border-radius:var(--border-radius);
 box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
 border: none;
 cursor:pointer;
 font-weight:700;
 color: white;
 opacity:0;
 animation:fadeIn 1s ease forwards;
 animation-delay:0.2s;
 transition: all 0.3s ease;
 min-height:64px;
 letter-spacing: 0.5px;
}

.clear-btn {
 width: 25%;
 background: var(--danger);
 font-size:18px;
 padding:20px 10px;
 border-radius:var(--border-radius);
 box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
 border: none;
 cursor:pointer;
 font-weight:700;
 color: white;
 opacity:0;
 animation:fadeIn 1s ease forwards;
 animation-delay:0.2s;
 transition: all 0.3s ease;
 min-height:64px;
 letter-spacing: 0.5px;
}

.save-btn:active, .note-value-btn:active, .clear-btn:active {
 transform: translateY(2px);
 box-shadow: 0 3px 12px rgba(0, 0, 0, 0.4); }

.save-btn:disabled {
 background: rgba(46, 125, 50, 0.5);
 cursor: not-allowed;
 transform: none;
 box-shadow: none;
}

.note-value-btn:disabled {
 background: rgba(156, 39, 176, 0.5);
 cursor: not-allowed;
 transform: none;
 box-shadow: none;
}

.clear-btn:disabled {
 background: rgba(244, 67, 54, 0.5);
 cursor: not-allowed;
 transform: none;
 box-shadow: none;
}

.numeric-keyboard-overlay {
 position: fixed;
 top: 0;
 left: 0;
 right: 0;
 bottom: 0;
 background: rgba(0, 0, 0, 0.8);
 display: none;
 align-items: center;
 justify-content: center;
 z-index: 10000;
 animation: fadeIn 0.3s ease;
 padding: 20px;
}

.numeric-keyboard-overlay.show { display: flex; }

.numeric-keyboard {
 background: var(--secondary);
 padding: 25px;
 border-radius: var(--border-radius);
 box-shadow: var(--shadow);
 width: 100%;
 max-width: 400px;
 border: 1px solid rgba(255, 255, 255, 0.1); }

.keyboard-header { text-align: center; margin-bottom: 20px; }

.keyboard-title { font-size: 24px; font-weight: 700; color: var(--text); margin-bottom: 8px; }

.keyboard-subtitle { font-size: 16px; color: var(--text-secondary); }

.keyboard-display {
 background: rgba(0, 0, 0, 0.3);
 padding: 20px;
 border-radius: 12px;
 font-size: 28px;
 text-align: center;
 margin-bottom: 20px;
 border: 2px solid rgba(255, 255, 255, 0.1);
 min-height: 70px;
 display: flex;
 align-items: center;
 justify-content: center;
 font-weight: 600;
}

.keyboard-row {
 display: flex;
 gap: 10px;
 margin-bottom: 10px;
 justify-content: center;
}

.keyboard-key {
 flex: 1;
 background: var(--primary);
 border: none;
 border-radius: 12px;
 padding: 20px 10px;
 font-size: 24px;
 font-weight: 700;
 color: var(--text);
 cursor: pointer;
 transition: all 0.2s ease;
 min-height: 70px;
 box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }

.keyboard-key:active {
 background: var(--accent);
 transform: translateY(2px);
 box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }

.keyboard-key.wide { flex: 2; }

.keyboard-key.clear { background: #f44336; }

.keyboard-key.submit { background: var(--accent); font-size: 20px; }

.fade-in { opacity:0; animation:fadeIn 0.7s ease forwards; }

@keyframes fadeIn {
 0%{opacity:0; transform:translateY(10px);}  100%{opacity:1; transform:translateY(0);} }

.loader {
 width:70px;
 height:70px;
 margin:50px auto;
 border-radius:50%;
 border: 5px solid rgba(15, 52, 96, 0.3);
 border-top: 5px solid var(--accent);
 animation: spin 1s linear infinite;
}

@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.modal-overlay {
 position: fixed;
 top: 0;
 left: 0;
 right: 0;
 bottom: 0;
 background: rgba(0, 0, 0, 0.8);
 display: none;
 align-items: center;
 justify-content: center;
 z-index: 9999;
 animation: fadeIn 0.3s ease;
 padding: 20px;
}

.modal-overlay.show { display: flex; }

.modal-content {
 background: var(--secondary);
 padding: 35px 25px;
 border-radius: var(--border-radius);
 box-shadow: var(--shadow);
 text-align: center;
 animation: scaleIn 0.3s ease;
 max-width: 90%;
 width: 340px;
 border: 1px solid rgba(255, 255, 255, 0.1); }

@keyframes scaleIn { 0% { transform: scale(0.8); opacity: 0; }  100% { transform: scale(1); opacity: 1; } }

.checkmark-circle {
 width: 100px;
 height: 100px;
 margin: 0 auto 20px;
 border-radius: 50%;
 background: var(--accent);
 display: flex;
 align-items: center;
 justify-content: center;
 box-shadow: 0 6px 20px rgba(46, 125, 50, 0.5); }

.checkmark {
 width: 50px;
 height: 50px;
 stroke: white;
 stroke-width: 4;
 fill: none;
 animation: checkmarkDraw 0.5s ease forwards; }

@keyframes checkmarkDraw {
 0% { stroke-dasharray: 0, 100; opacity: 0; }
 100% { stroke-dasharray: 100, 100; opacity: 1; }
}

.saved-text { font-size: 28px; font-weight: bold; color: var(--text); margin-bottom: 10px; }

.saved-subtext { font-size: 18px; color: var(--text-secondary); }

.icon { width: 26px; height: 26px; stroke: var(--accent); stroke-width: 2.2; fill: none; }

.footer { text-align: center; padding: 20px; color: var(--text-secondary); font-size: 16px; margin-top: 16px; }

@media (max-width: 480px) {
 body { font-size: 18px; }
 .topbar { font-size: 24px; padding: 18px 12px; }
 .card { padding: 18px; }
 .form-group { margin-bottom: 14px; }
 label { font-size: 20px; }
 select, input { padding: 16px; font-size: 20px; min-height: 60px; }
 .save-btn, .note-value-btn, .clear-btn { padding: 18px; font-size: 20px; min-height: 60px; }
 .note-value-btn, .clear-btn { font-size: 18px; padding: 18px 8px; }
 .last-checked-display { font-size: 20px; padding: 16px; min-height: 60px; }
 .saved-text { font-size: 26px; }
 .numeric-keyboard { padding: 20px; }
 .keyboard-key { padding: 16px 8px; font-size: 20px; min-height: 60px; }
 .keyboard-display { font-size: 24px; padding: 16px; min-height: 60px; }
 .keyboard-title { font-size: 22px; }
}

::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 5px; }
::-webkit-scrollbar-thumb:hover { background: rgba(46, 125, 50, 0.8); }
select:focus, input:focus, button:focus { outline: 2px solid var(--accent); outline-offset: 2px; }
select option { background: var(--secondary); color: var(--text); font-size: 20px; padding: 12px; height: 50px; }
select { font-size: 22px !important; }
select option { font-size: 20px !important; padding: 15px 10px !important; line-height: 1.5 !important; }
</style>
</head>

<body>
<div class="topbar">
 <svg class="icon" width="28" height="28" viewBox="0 0 24 24">
   <path d="M13 2L3 14h8l-1 8 10-12h-8l1-8z"/>  
 </svg>  
 Mätaravläsning 
</div> 

<div id="loader" class="loader"></div>

<div class="app" id="app">
<div class="card">
<div class="form-group">
<label>
 <svg class="icon" width="26" height="26" viewBox="0 0 24 24">
   <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
   <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>  
 </svg>  
 Uppdrag 
</label> 
<select id="uppdrag"></select> 
</div>

<div class="form-group">
<label>
 <svg class="icon" width="26" height="26" viewBox="0 0 24 24">
   <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
   <polyline points="9 22 9 12 15 12 15 22"/>  
 </svg>  
 Fastighet 
</label> 
<select id="fastighet"></select> 
</div>

<div class="form-group">
<label>
 <svg class="icon" width="26" height="26" viewBox="0 0 24 24">
   <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
   <circle cx="12" cy="10" r="3"/>
 </svg>
 Adress
</label>
<select id="adress"></select>
</div>

<div class="form-group">
<label>
 <svg class="icon" width="26" height="26" viewBox="0 0 24 24">
   <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
   <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
 </svg>
 Mätarnummer
</label>
<select id="matarnummer"></select>
</div>

<div class="form-group">
<label>
 <svg class="icon" width="26" height="26" viewBox="0 0 24 24">
   <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
   <line x1="16" y1="2" x2="16" y2="6"/>
   <line x1="8" y1="2" x2="8" y2="6"/>
   <line x1="3" y1="10" x2="21" y2="10"/>  
 </svg>  
 Senast avläst värde:
</label>
<div id="latest" class="last-checked-display">Välj mätarnummer för att se senaste värde</div>
</div>

<div class="buttons-container">
<button class="note-value-btn" id="noteValueBtn" onclick="showNumericKeyboard()">Notera värde</button>
<button class="clear-btn" onclick="clearForm()">Rensa</button>
</div>
<button class="save-btn" id="saveBtn" onclick="save()" disabled>Spara</button>
</div>
</div>

<div class="modal-overlay" id="savedModal">
 <div class="modal-content">
   <div class="checkmark-circle">
     <svg class="checkmark" viewBox="0 0 52 52">
       <path d="M14 27l7 7 17-17"/>
     </svg>
   </div>
   <div class="saved-text">Sparat!</div>
   <div class="saved-subtext">Värdet har registrerats</div>
 </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec";
let allData = [];
let meterValue = null;

async function loadData() {
  try {
    const res = await fetch(API_URL);
    const json = await res.json();
    if(json.status === "success") {
      allData = json.data;
      const uppdragItems = [...new Set(allData.map(row=>row.Uppdrag))];
      fillSelect("uppdrag", uppdragItems);
      document.getElementById("loader").style.display="none";
      document.getElementById("app").style.display="block";
    }
  } catch(e){ console.error(e); }
}

function updateLastChecked(){
    const uppdrag = document.getElementById("uppdrag").value;
    const fastighet = document.getElementById("fastighet").value;
    const adress = document.getElementById("adress").value;
    const matarnummer = document.getElementById("matarnummer").value;

    if(!uppdrag || !fastighet || !adress || !matarnummer){
        document.getElementById("latest").textContent = "Välj mätarnummer för att se senaste värde";
        return;
    }

    const selected = allData.find(row => 
        row.Uppdrag === uppdrag &&
        row.Fastighet === fastighet &&
        row.Adress === adress &&
        row.Mätarnummer === matarnummer
    );

    document.getElementById("latest").textContent =
        selected && selected.SenasteVärde ? selected.SenasteVärde : "Inget tidigare värde registrerat";
    validateForm();
}

function fillSelect(id, items){
    const el = document.getElementById(id);
    el.innerHTML = `<option value="">Välj...</option>` + 
        items.map(i => `<option value="${i}">${i}</option>`).join("");
}

function validateForm(){
    const enabled =
        document.getElementById("uppdrag").value &&
        document.getElementById("fastighet").value &&
        document.getElementById("adress").value &&
        document.getElementById("matarnummer").value &&
        meterValue !== null;

    document.getElementById("saveBtn").disabled = !enabled;
}

async function save(){
    const payload = {
        uppdrag : document.getElementById("uppdrag").value,
        fastighet : document.getElementById("fastighet").value,
        adress : document.getElementById("adress").value,
        matarnummer : document.getElementById("matarnummer").value,
        varde : meterValue
    };

    const res = await fetch(API_URL,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(payload)
    });

    if(res.ok){
        showSaved();
        document.getElementById("noteValueBtn").textContent = "Notera värde";
        meterValue = null;
    }
}

function showSaved(){
    const modal = document.getElementById("savedModal");
    modal.classList.add("show");
    setTimeout(()=> modal.classList.remove("show"),1600);
}

function clearForm(){
    document.getElementById("uppdrag").value = "";
    document.getElementById("fastighet").innerHTML = "";
    document.getElementById("adress").innerHTML = "";
    document.getElementById("matarnummer").innerHTML = "";
    document.getElementById("latest").textContent = "Välj mätarnummer för att se senaste värde";
    meterValue = null;
    document.getElementById("noteValueBtn").textContent = "Notera värde";
    validateForm();
}

window.onload = loadData;
</script>
</body>
</html>
